{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">Add Lab Results</h3>
  <div class="col-md-12">
    <label class="form-label fw-semibold">Consultation</label>

    <!-- Custom dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-secondary w-100 dropdown-toggle consultation-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        {% if consultation.id %}
        {{consultation.patient.name}}
        {% else %}
        Select Consultation
        {% endif %}
      </button>
      <input
        type="text"
        id="consultation-search"
        class="form-control"
        placeholder="Search patient..."
      >
     
      <ul id="consultation-results" class="dropdown-menu show"></ul>
    </div>

    
  </div>

  <form method="post" id="lab-results-form">
    {% csrf_token %}
    {{ formset.management_form }}
    <input type="hidden" name="consultation_id" id="consultation-id">
    <div id="formset-container">
      {% for form in formset %}
      <div class="formset-item border rounded p-3 mb-3 shadow-sm position-relative">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0 text-primary fw-semibold">Result {{ forloop.counter }}</h5>
          {% if formset.can_delete %}
          <button type="button" class="btn btn-outline-danger btn-sm remove-form">
            <i class="bi bi-x-circle"></i> Remove
          </button>
          {% endif %}
        </div>

        <div class="row g-3">
          <!-- Consultation -->
          
          <!-- Lab Test -->
          <div class="col-md-12">
            <label class="form-label fw-semibold">Lab Test</label>

            <div class="dropdown">
              <button class="btn btn-outline-secondary w-100 dropdown-toggle labtest-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Select Lab Test
              </button>
              <ul class="dropdown-menu w-100 p-2">
                <input type="text" class="form-control mb-2 labtest-search" placeholder="Search Lab Test...">
                {% for t in lab_tests %}
                <li>
                  <a class="dropdown-item labtest-option" data-value="{{ t.id }}">{{ t.name }}</a>
                </li>
                {% endfor %}
              </ul>
            </div>

            <div class="d-none">
              {{ form.lab_test }}
            </div>
          </div>

          <!-- Result Name -->
          <div class="col-md-6">
            {{ form.result_name|as_crispy_field }}
          </div>

          <!-- Result Value -->
          <div class="col-md-6">
            {{ form.result_value|as_crispy_field }}
          </div>

        </div>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button type="button" id="add-form" class="btn btn-outline-primary">âž• Add Another Result</button>
      <button type="submit" class="btn btn-success px-5">ðŸ’¾ Save All Results</button>
    </div>
  </form>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const formContainer = document.getElementById("formset-container");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");
  const addFormBtn = document.getElementById("add-form");
  const input = document.getElementById("consultation-search");
  const results = document.getElementById("consultation-results");
  const consultationHidden = document.getElementById("consultation-id");
  const consultationBtn = document.querySelector(".consultation-btn");

  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length < 2) {
      results.innerHTML = "";
      return;
    }

    const res = await fetch(`/emr/consultations/search/?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    results.innerHTML = data.map(item => `
      <li>
        <a class="dropdown-item consultation-option" data-id="${item.id}">
          ${item.label}
        </a>
      </li>
    `).join("");
  });

  results.addEventListener("click", e => {
    if (!e.target.classList.contains("consultation-option")) return;

    e.preventDefault();
    consultationHidden.value = e.target.dataset.id;
    consultationBtn.textContent = e.target.textContent.trim();
    results.innerHTML = "";
    console.log(e.target);
  });

  // Reindex forms
  function reindexForms() {
    const items = formContainer.querySelectorAll(".formset-item");
    items.forEach((item, index) => {
      item.querySelectorAll("[name]").forEach(el => {
        if (el.name.match(/^form-\d+-/)) {
          el.name = el.name.replace(/form-(\d+)-/, `form-${index}-`);
          el.id = el.id.replace(/form-(\d+)-/, `form-${index}-`);
        }
      });
      const header = item.querySelector("h5");
      if (header) header.textContent = `Result ${index + 1}`;
    });
    totalForms.value = items.length;
  }

  // Add new form
  addFormBtn.addEventListener("click", () => {
    const items = formContainer.querySelectorAll(".formset-item");
    if (items.length === 0) return;

    const newItem = items[items.length - 1].cloneNode(true);
    newItem.querySelectorAll("input, textarea, select").forEach(el => {
      if (el.type !== "hidden") el.value = "";
    });
    newItem.querySelectorAll(".consultation-btn").forEach(btn => btn.textContent = "Select Consultation");
    newItem.querySelectorAll(".labtest-btn").forEach(btn => btn.textContent = "Select Lab Test");
    formContainer.appendChild(newItem);
    reindexForms();
  });

  // Remove form
  formContainer.addEventListener("click", (e) => {
    if (e.target.closest(".remove-form")) {
      const item = e.target.closest(".formset-item");
      if (formContainer.querySelectorAll(".formset-item").length > 1) {
        item.remove();
        reindexForms();
      } else {
        alert("At least one result form must remain.");
      }
    }
  });

  // Dropdown selections
  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("labtest-option")) {
      const dropdown = e.target.closest(".dropdown");
      const btn = dropdown.querySelector(".labtest-btn");
      const hiddenSelect = dropdown.closest(".formset-item").querySelector('[name$="-lab_test"]');
      btn.textContent = e.target.textContent.trim();
      hiddenSelect.value = e.target.dataset.value;
      bootstrap.Dropdown.getInstance(btn)?.hide();
    }
  });

  // Search filtering
  document.addEventListener("input", function(e) {
    if (e.target.classList.contains("labtest-search")) {
      const term = e.target.value.toLowerCase();
      const options = e.target.closest("ul").querySelectorAll(".labtest-option");
      options.forEach(opt => opt.style.display = opt.textContent.toLowerCase().includes(term) ? "" : "none");
    }
  });

  reindexForms();
});
</script>
{% endblock %}
{% endblock %}
