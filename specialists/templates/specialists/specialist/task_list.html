{% extends "specialists/base.html" %}
{% load crispy_forms_tags %}
{% block title %}Specialists Area | Specialists Hub{% endblock %}

{% block content_inner %}

<!-- Header -->
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
  <div>
    <h3 class="fw-bold mb-1">Specialists Area</h3>
    <div class="text-secondary">
      Track patient workflow, assign specialist, attach service, and bill in one click.
    </div>
  </div>
  <a class="btn btn-primary" href="{% url 'specialists:task_create' %}">
    + New Task
  </a>
</div>

<!-- Filters -->
<div class="card border-0 shadow-sm rounded-4 mb-4">
  <div class="card-body p-4">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <div class="fw-semibold">Filters</div>
        <div class="text-secondary small">Narrow down tasks by role and status.</div>
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'specialists:task_list' %}">
        Reset
      </a>
    </div>

    <form method="get" class="row g-3 align-items-end">
      <div class="col-12 col-md-6 col-lg-5">
        <label class="form-label fw-semibold">Role</label>
        <input
          class="form-control"
          name="role"
          value="{{ request.GET.role }}"
          placeholder="e.g. sonographer, cardiologist"
        />
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <label class="form-label fw-semibold">Status</label>
        <select class="form-select" name="status">
          <option value="">All</option>
          <option value="waiting" {% if request.GET.status == "waiting" %}selected{% endif %}>Waiting</option>
          <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>In Progress</option>
          <option value="done" {% if request.GET.status == "done" %}selected{% endif %}>Done</option>
          <option value="cancelled" {% if request.GET.status == "cancelled" %}selected{% endif %}>Cancelled</option>
        </select>
      </div>

      <div class="col-12 col-lg-3 d-flex gap-2">
        <button class="btn btn-primary w-100" type="submit">Filter</button>
        <a class="btn btn-outline-secondary w-100" href="{% url 'specialists:task_list' %}">Reset</a>
      </div>
    </form>
  </div>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm rounded-4">
  <div class="card-body p-0">

    <div class="d-flex justify-content-between align-items-center px-4 pt-4 pb-3">
      <div>
        <div class="fw-semibold">Tasks</div>
        <div class="text-secondary small">
          Showing {{ tasks|length }} result{{ tasks|length|pluralize }}
        </div>
      </div>

      <span class="badge text-bg-light border rounded-pill">
        Tip: Assign a service so billing becomes one click.
      </span>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-nowrap">Created</th>
            <th>Patient</th>
            <th>Role</th>
            <th>Status</th>
            <th>Service</th>
            <th>Billing</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for t in tasks %}
          <tr>
            <td class="text-secondary text-nowrap">{{ t.created_at|date:"Y-m-d H:i" }}</td>

            <td>
              <div class="fw-semibold">{{ t.patient.name }}</div>
              {% if t.consultation_id %}
                <div class="text-secondary small">Consultation: {{ t.consultation_id }}</div>
              {% endif %}
            </td>

            <td>
              <span class="badge text-bg-light border rounded-pill">{{ t.role }}</span>
            </td>

            <td>
              {% if t.status == "done" %}
                <span class="badge text-bg-success rounded-pill">Done</span>
              {% elif t.status == "in_progress" %}
                <span class="badge text-bg-warning rounded-pill">In progress</span>
              {% elif t.status == "cancelled" %}
                <span class="badge text-bg-secondary rounded-pill">Cancelled</span>
              {% else %}
                <span class="badge text-bg-info rounded-pill">{{ t.get_status_display }}</span>
              {% endif %}
            </td>

            <td class="text-secondary">
              {{ t.service.name|default:"—" }}
            </td>

            <td class="text-secondary">
              {% if t.bill %}
                <span class="badge text-bg-light border rounded-pill">Bill #{{ t.bill.id }}</span>
              {% else %}
                —
              {% endif %}
            </td>

            <td class="text-end">
              {% if t.service and not t.bill %}
                <a class="btn btn-sm btn-primary" href="{% url 'specialists:task_bill_service' t.id %}">
                  Bill Service
                </a>
              {% elif t.bill %}
                <span class="badge text-bg-success rounded-pill">Billed</span>
              {% else %}
                <span class="badge text-bg-warning rounded-pill">No service</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-secondary py-5">
              No specialist tasks found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <div class="card-footer bg-white border-0 px-4 py-3">
    <div class="text-secondary small">
      Tip: Assign a service to each task so billing becomes one click.
    </div>
  </div>
</div>

{% endblock %}
